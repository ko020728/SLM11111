<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²½ë§¤ ì§„í–‰ì ì œì–´ ë° ê´€ê° ê³µìœ  í™”ë©´</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; display: flex; gap: 20px; }
        .column { padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }

        /* ********** íƒ­ ë©”ë‰´ ********** */
        .tab-menu { display: flex; margin-bottom: 20px; }
        .tab-menu button {
            padding: 10px 20px; border: 1px solid #ddd; background-color: #f8f9fa; cursor: pointer;
            border-bottom: none; border-radius: 5px 5px 0 0; font-weight: bold;
        }
        .tab-menu button.active { background-color: #fff; border-color: #007bff; border-bottom: 1px solid #fff; color: #007bff; }
        .tab-content { border-top: 1px solid #ddd; padding-top: 20px; }

        /* ********** ê´€ê° ê³µìœ  UI (ê²½ë§¤ ì§„í–‰ íƒ­) ********** */
        .left-panel { flex: 1; min-width: 300px; } /* íŒ€ í˜„í™© */
        .center-panel { flex: 2; display: flex; flex-direction: column; gap: 20px; } /* ê²½ë§¤ ì¤‘ì•™ ì œì–´ */
        .right-panel { flex: 1; min-width: 300px; } /* ì œì–´ ë° ë¡œê·¸ */
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 0; color: #007bff; }
        
        /* íŒ€ ìƒíƒœ */
        .team-status-box { margin-bottom: 15px; padding: 10px; border: 2px solid #ddd; border-radius: 6px; }
        .team-status-box h3 { margin: 0; font-size: 1.1em; color: #007bff; display: flex; justify-content: space-between; align-items: center; }
        .team-budget { font-size: 1.2em; color: #28a745; font-weight: bold; }
        .team-roster { font-size: 0.85em; margin-top: 5px; color: #666; }
        .roster-limit { color: red; font-weight: bold; }

        /* ********** íŒ€ í˜„í™© GRID ë ˆì´ì•„ì›ƒ ì ìš© (View ë° Control íƒ­) ********** */
        #team-status-container-control,
        #team-status-container-view { /* View íƒ­ ì»¨í…Œì´ë„ˆ ì¶”ê°€ */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* 200px ìµœì†Œ ë„ˆë¹„ë¡œ ìë™ ì •ë ¬ */
            gap: 15px;
            padding: 10px 0; /* ì»¨í…Œì´ë„ˆ ë‚´ë¶€ íŒ¨ë”© */
        }
        /* ************************************************************* */

        /* ê²½ë§¤ ì¤‘ì•™ */
        #current-item-info { text-align: center; padding: 20px; background-color: #e9ecef; border-radius: 6px; }
        #current-item-info h3 { font-size: 1.8em; color: #dc3545; margin-bottom: 10px; }
        #current-item-info ul { list-style: none; padding: 0; margin: 0; display: flex; justify-content: center; gap: 20px; font-size: 1.1em; }

        /* ì‹¤ì‹œê°„ í˜„í™© */
        .live-status-section { text-align: center; }
        .live-status { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px 0; border-top: 1px solid #eee; }
        .status-box { background-color: #f8f9fa; padding: 10px; border-radius: 4px; }
        .status-label { font-size: 0.9em; color: #6c757d; }
        #countdown-timer-host { font-size: 2em; color: #dc3545; font-weight: bold; }
        #current-bid { font-size: 2em; color: #28a745; font-weight: bold; }
        
        /* ì œì–´ ë° ë¡œê·¸ (ìš°ì¸¡ íŒ¨ë„) */
        .control-section button { padding: 10px 15px; margin: 5px 0; width: 100%; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; transition: background-color 0.2s; }
        #start-next-auction-button { background-color: #007bff; color: white; }
        #end-auction-button { background-color: #dc3545; color: white; }
        
        /* ìœ ì°°ì ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #start-raffle-button { background-color: #ffaa00; color: white; }
        #assign-player-button { background-color: #007bff; color: white; }
        #reset-auction-button { background-color: #8b0000; color: white; } /* ğŸ”´ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */


        #end-auction-button:disabled, #start-next-auction-button:disabled, #start-raffle-button:disabled, #assign-player-button:disabled { background-color: #ccc; cursor: not-allowed; }
        #host-message-container { max-height: 200px; overflow-y: auto; font-size: 0.9em; }

        /* ********** ê´€ë¦¬ íƒ­ ìš”ì†Œ ********** */
        .setup-item { margin-bottom: 20px; padding: 15px; border: 1px dashed #ccc; border-radius: 4px; }
        .setup-item h3 { margin-top: 0; color: #6c757d; }
        .assign-captain-btn { margin-left: 10px; cursor: pointer; border: 1px solid #007bff; background-color: #eaf3ff; padding: 3px 8px; font-size: 0.9em; border-radius: 3px; }
        /* ********** ê³µí†µ ìŠ¤íƒ€ì¼ ********** */
        .hidden-section { display: none; }
    </style>
</head>
<body>
    <h1>ê²½ë§¤ ì§„í–‰ì & ê´€ê° ê³µìœ  í™”ë©´</h1>
    
    <div class="tab-menu">
        <button id="tab-view-btn" class="active">ê²½ë§¤ ì§„í–‰ (ê´€ê° ê³µìœ ìš©)</button>
        <button id="tab-control-btn">ê²½ë§¤ ê´€ë¦¬ (Host ì „ìš©)</button>
    </div>

    <div id="tab-view" class="tab-content container">

        <div class="column left-panel">
            <h2>ğŸ“Š íŒ€ ìƒíƒœ ëª¨ë‹ˆí„°ë§</h2>
            <div id="team-status-container-view"></div>
        </div>

        <div class="column center-panel">
            <div id="current-item-section">
                <h2>ğŸ”¥ í˜„ì¬ ê²½ë§¤ ì„ ìˆ˜</h2>
                <div id="current-item-info-view">ê²½ë§¤ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>
            </div>
            
            <div class="live-status-section">
                <h2>ğŸ“¢ ì‹¤ì‹œê°„ í˜„í™©</h2>
                <div class="live-status">
                    <div class="status-box">
                        <div class="status-label">ë‚¨ì€ ì‹œê°„</div>
                        <div id="countdown-timer-view">ê²½ë§¤ ëŒ€ê¸°</div>
                    </div>
                    <div class="status-box">
                        <div class="status-label">í˜„ì¬ ìµœê³ ê°€</div>
                        <div id="current-bid-view">0ì›</div>
                    </div>
                    <div class="status-box">
                        <div class="status-label">ìµœê³  ì…ì°°ì</div>
                        <div id="highest-bidder-nickname-view">ì—†ìŒ</div>
                    </div>
                    <div class="status-box">
                        <div class="status-label">ê²½ë§¤ ìƒíƒœ</div>
                        <div id="auction-status-view">ëŒ€ê¸° ì¤‘</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="column right-panel">
            <div class="control-section">
                <h2>ğŸ•¹ï¸ ê²½ë§¤ ì œì–´</h2>
                <button id="start-next-auction-button">ë‹¤ìŒ ê²½ë§¤ ì‹œì‘</button>
                <button id="end-auction-button" disabled>ê²½ë§¤ ì¢…ë£Œ ë° ìë™ ë‚™ì°° ì²˜ë¦¬</button>
                <button id="start-raffle-button" disabled>ìœ ì°°ì ê²½ë§¤ ì‹œì‘ (ëœë¤)</button>
                <button id="assign-player-button" disabled>ê°•ì œ íŒ€ ë°°ì •</button> <hr> <button id="reset-auction-button">ğŸ”´ ì „ì²´ ê²½ë§¤ ì´ˆê¸°í™”</button> </div>
            
            <hr>
            
            <h2>âœ… ìµœê·¼ ë¡œê·¸/ê²°ê³¼</h2>
            <div id="result-message-view">ê²½ë§¤ ëŒ€ê¸° ì¤‘...</div>

            <hr>
            
            <h2>ì ‘ì†ì í˜„í™©</h2>
            <p style="font-size: 0.9em;">ì´ <span id="user-count-view">0</span>ëª… ì ‘ì† ì¤‘</p>
        </div>

    </div>

    <div id="tab-control" class="tab-content container hidden-section">
        
        <div class="column left-panel">
            <h2>âš™ï¸ ì‚¬ì „ ì„¤ì • ë° ì œì–´</h2>
            
            <div class="setup-item">
                <h3>1. íŒ€ ë“±ë¡</h3>
                <form id="add-team-form">
                    <label>íŒ€ëª…: <input type="text" id="team-name" required></label>
                    <label>ì´ˆê¸° ì˜ˆì‚°: <input type="number" id="team-budget" min="1" value="10000" required></label>
                    <button type="submit">íŒ€ ë“±ë¡</button>
                    <button type="button" id="clear-teams-button" style="color: red;">ì „ì²´ íŒ€ ì´ˆê¸°í™”</button>
                </form>
            </div>

            <div class="setup-item">
                <h3>2. ì„ ìˆ˜ ë“±ë¡</h3>
                <form id="add-item-form">
                    <label>ë‹‰ë„¤ì„: <input type="text" id="item-nickname" required></label>
                    <label>ë‚´ì „í‹°ì–´: <select id="item-tier" required>
                        <optgroup label="Master"><option value="M1">M1</option><option value="M2">M2</option><option value="M3">M3</option><option value="M4">M4</option></optgroup>
                        <optgroup label="Diamond"><option value="D1">D1</option><option value="D2">D2</option><option value="D3">D3</option><option value="D4">D4</option></optgroup>
                        <optgroup label="Emerald"><option value="E1">E1</option><option value="E2">E2</option><option value="E3">E3</option><option value="E4">E4</option></optgroup>
                        <optgroup label="Platinum"><option value="P1">P1</option><option value="P2">P2</option><option value="P3">P3</option><option value="P4">P4</option></optgroup>
                    </select></label><br>
                    <label>ì ìˆ˜: <input type="number" id="item-score" min="0" value="0"></label>
                    <label>ì£¼ í¬ì§€ì…˜: <select id="item-mainpos" required>
                        <option value="Top">Top</option><option value="Jug">Jug</option><option value="Mid">Mid</option><option value="Ad">Ad</option><option value="Sup">Sup</option>
                    </select></label>
                    <label>ë¶€ í¬ì§€ì…˜: <select id="item-subpos">
                        <option value="">(ì„ íƒ ì•ˆí•¨)</option><option value="Top">Top</option><option value="Jug">Jug</option><option value="Mid">Mid</option><option value="Ad">Ad</option><option value="Sup">Sup</option>
                    </select></label><br>
                    <button type="submit">ì„ ìˆ˜ ë“±ë¡</button>
                    <button type="button" id="clear-items-button" style="color: red;">ì „ì²´ ì„ ìˆ˜ ì´ˆê¸°í™”</button>
                </form>
            </div>
            
        </div>

        <div class="column center-panel">
            <div class="setup-item">
                <h3>3. ê²½ë§¤ ì¤€ë¹„</h3>
                <button type="button" id="shuffle-button">ê²½ë§¤ ìˆœì„œ ë¬´ì‘ìœ„ ì„ê¸°</button>
                <p style="margin-top: 10px;">ì„ ìˆ˜ ëª©ë¡ (<span id="item-count-control">0</span>ëª…)</p>
                <table id="item-list-table" class="item-info-table"></table>
            </div>

            <div class="setup-item">
                <h3>4. ì ‘ì† ì‚¬ìš©ì ë° íŒ€ì¥ ì§€ì •</h3>
                <p>ì´ <span id="user-count-control">0</span>ëª… ì ‘ì† ì¤‘</p>
                <ul id="user-list-control"></ul>
            </div>
            
            <div class="setup-item">
                <h3>5. íŒ€ í˜„í™© ìš”ì•½</h3>
                <div id="team-status-container-control"></div>
            </div>
        </div>
    </div>


    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        // íƒ­ ìš”ì†Œ
        const tabViewBtn = document.getElementById('tab-view-btn');
        const tabControlBtn = document.getElementById('tab-control-btn');
        const tabView = document.getElementById('tab-view');
        const tabControl = document.getElementById('tab-control');

        // View íƒ­ ìš”ì†Œ (ê´€ê° ê³µìœ ìš©)
        const currentItemDivView = document.getElementById('current-item-info-view');
        const currentBidElementView = document.getElementById('current-bid-view');
        const highestBidderNicknameElementView = document.getElementById('highest-bidder-nickname-view');
        const statusElementView = document.getElementById('auction-status-view');
        const countdownTimerView = document.getElementById('countdown-timer-view');
        const teamStatusContainerView = document.getElementById('team-status-container-view');
        const resultDivView = document.getElementById('result-message-view');
        const userCountView = document.getElementById('user-count-view');
        
        // Control íƒ­ ìš”ì†Œ (Host ì „ìš©)
        const addTeamForm = document.getElementById('add-team-form');
        const clearTeamsButton = document.getElementById('clear-teams-button');
        const addItemForm = document.getElementById('add-item-form');
        const clearItemsButton = document.getElementById('clear-items-button');
        const shuffleButton = document.getElementById('shuffle-button');
        const itemListTable = document.getElementById('item-list-table');
        const itemCountControl = document.getElementById('item-count-control');
        const userListControl = document.getElementById('user-list-control');
        const userCountControl = document.getElementById('user-count-control');
        const teamStatusContainerControl = document.getElementById('team-status-container-control'); // Control íƒ­ì˜ íŒ€ í˜„í™© ì»¨í…Œì´ë„ˆ
        
        // ì œì–´ ë²„íŠ¼ (ë‘ íƒ­ì—ì„œ ì ‘ê·¼)
        const startNextButton = document.getElementById('start-next-auction-button');
        const endButton = document.getElementById('end-auction-button');
        const startRaffleButton = document.getElementById('start-raffle-button');Â 
        const assignPlayerButton = document.getElementById('assign-player-button');
        const resetAuctionButton = document.getElementById('reset-auction-button'); // â¬…ï¸ [ê²½ë§¤ ì´ˆê¸°í™” ê¸°ëŠ¥] ë²„íŠ¼ ìš”ì†Œ
        
        // ìƒíƒœ ë³€ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
        let allItems = [];Â 
        let allTeams = [];
        let currentBidData = {};Â 
        let captainMap = {};Â 


        // ********** íƒ­ ì „í™˜ ë¡œì§ **********
        tabViewBtn.addEventListener('click', () => {
            tabViewBtn.classList.add('active');
            tabControlBtn.classList.remove('active');
            tabView.classList.remove('hidden-section');
            tabControl.classList.add('hidden-section');
        });

        tabControlBtn.addEventListener('click', () => {
            tabControlBtn.classList.add('active');
            tabViewBtn.classList.remove('active');
            tabControl.classList.remove('hidden-section');
            tabView.classList.add('hidden-section');
        });

        // ********** API Helper **********
        async function fetchItems() {
              const response = await fetch('/api/items');
              allItems = await response.json();
              renderItemList(allItems);
        }

        // ********** íŒ€ ë° ì„ ìˆ˜ ê´€ë¦¬ API í†µì‹  **********
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // í¼ ì œì¶œ ê¸°ë³¸ ë™ì‘ ë°©ì§€

            const newItem = {
                nickname: document.getElementById('item-nickname').value,
                tier: document.getElementById('item-tier').value,
                score: parseInt(document.getElementById('item-score').value),
                mainPos: document.getElementById('item-mainpos').value,
                subPos: document.getElementById('item-subpos').value,
            };
            
            // ì„œë²„ API í˜¸ì¶œ
            const response = await fetch('/api/item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newItem)
            });

            // ì‘ë‹µ í™•ì¸ ë° ëª©ë¡ ê°±ì‹ 
            if (response.ok) {
                addItemForm.reset(); // í¼ ì´ˆê¸°í™”
                fetchItems();Â  Â  Â  Â // ëª©ë¡ ê°±ì‹  (ì„œë²„ë¡œë¶€í„° ìµœì‹  ë°ì´í„° ìš”ì²­)
            } else {
                  alert(`ì„ ìˆ˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì‘ë‹µ ì½”ë“œ: ${response.status})`);
            }
        });

        clearItemsButton.addEventListener('click', async () => {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ì„ ìˆ˜ ëª©ë¡ì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await fetch('/api/items', { method: 'DELETE' });
                fetchItems();
            }
        });
        
        addTeamForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const teamName = document.getElementById('team-name').value.trim();
            const budget = parseInt(document.getElementById('team-budget').value);
            
            if (teamName && budget >= 0) {
                socket.emit('addTeam', { name: teamName, budget: budget });
                document.getElementById('team-name').value = '';
            } else {
                alert('íŒ€ ì´ë¦„ê³¼ ìœ íš¨í•œ ì˜ˆì‚°ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            }
        });

        clearTeamsButton.addEventListener('click', async () => {
            if (confirm('ê²½ë§¤ë¥¼ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê¸° ìœ„í•´ ëª¨ë“  íŒ€ì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì„ ìˆ˜ ëª©ë¡ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.)')) {
                await fetch('/api/teams', { method: 'DELETE' });
                await fetch('/api/items', { method: 'DELETE' });
                fetchItems();
            }
        });

        // ********** ë Œë”ë§ í•¨ìˆ˜ (View/Controlì— ë§ì¶° ë¶„ë¦¬) **********
        
        function renderItemList(items) {
            allItems = items;
            itemCountControl.textContent = items.length; // Control íƒ­ ì—…ë°ì´íŠ¸
            
            let header = `<thead><tr><th>ìˆœì„œ</th><th>ë‹‰ë„¤ì„</th><th>í‹°ì–´/ì ìˆ˜</th><th>ì£¼/ë¶€í¬ì§€ì…˜</th><th>ì†Œê°œ</th><th>ìƒíƒœ</th></tr></thead><tbody>`;
            let rows = items.map((item, index) => {
                const rowClass = item.isAuctioned ? 'is-auctioned' : '';
                const status = item.isAuctionedÂ 
                    ? `ë‚™ì°°: ${item.winner} (${item.finalBid.toLocaleString()}ì›)`Â 
                    : (item.winner ? `ìœ ì°°` : 'ê²½ë§¤ ëŒ€ê¸°');

                // item.introê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ë³¸ê°’ ì„¤ì •
                const intro = item.intro !== undefined ? item.intro : '-';Â 

                return `<tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${item.nickname}</td>
                        <td>${item.tier} (${item.score})</td>
                        <td>${item.mainPos} / ${item.subPos || '-'}</td>
                        <td>${intro || '-'}</td>
                        <td>${status}</td>
                    </tr>
                `;
            }).join('');
            
            itemListTable.innerHTML = header + rows + '</tbody>';
        }

        function renderTeamStatus(teams, targetContainer) {
            
            if (teams.length === 0) {
                targetContainer.innerHTML = '<p>ë“±ë¡ëœ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // Grid Layout ì ìš©
            let teamHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">`;

            teamHTML += teams.map(team => {
                const isRosterFull = team.players.length >= 4;
                const roster = team.players.map(p => `${p.nickname} (${p.pos})`).join(', ') || 'ì—†ìŒ';
                
                return `
                    <div class="team-status-box" style="border-color: ${isRosterFull ? 'red' : '#007bff'};">
                        <h3 style="color:#007bff;">${team.name} <span style="font-size: 0.7em; color: ${isRosterFull ? 'red' : 'green'};">(${team.players.length}/4)</span></h3>
                        <p>ë‚¨ì€ ì˜ˆì‚°: <strong>${team.budget.toLocaleString()}</strong>ì›</p>
                        <p class="team-roster">ë¡œìŠ¤í„°: ${roster}</p>
                    </div>
                `;
            }).join('');
            
            teamHTML += `</div>`;
            targetContainer.innerHTML = teamHTML;
        }
        
        function renderUserList(users, captainMap, teams) {
            userCountControl.textContent = users.length;
            userCountView.textContent = users.length;

            const teamNames = teams.map(t => t.name);
            
            userListControl.innerHTML = users.map(nickname => {
                const assignedTeam = captainMap[nickname];
                const teamStatus = assignedTeamÂ 
                    ? `<span style="color: green; font-weight: bold;">(íŒ€ì¥: ${assignedTeam})</span>`
                    : `<span style="color: gray;">(ë¯¸ì§€ì •)</span>`;

                const buttons = teamNames.map(teamName => {
                    const isAssigned = assignedTeam === teamName;
                    const isDisabled = isAssigned;Â 
                    const buttonText = isAssigned ? 'âœ… ì§€ì •ë¨' : `[${teamName}] íŒ€ì¥ ì§€ì •`;
                    
                    return `<button class="assign-captain-btn" data-nickname="${nickname}" data-team="${teamName}" ${isDisabled ? 'disabled' : ''}>${buttonText}</button>`;
                }).join('');

                return `<li>${nickname} ${teamStatus} ${buttons}</li>`;
            }).join('');
            
            // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.querySelectorAll('.assign-captain-btn').forEach(button => {
                if (!button.disabled) {
                    button.addEventListener('click', (e) => {
                        const nickname = e.target.dataset.nickname;
                        const teamName = e.target.dataset.team;
                        
                        socket.emit('assignCaptain', { nickname, teamName });
                    });
                }
            });
        }


        // ********** Socket.io ì´ë²¤íŠ¸ ì²˜ë¦¬ **********

        // ê²½ë§¤ ìˆœì„œ ì„ê¸° ëª…ë ¹ ì „ì†¡
        shuffleButton.addEventListener('click', async () => {
              if (confirm('ê²½ë§¤ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ê³  ì²« ê²½ë§¤ ì¤€ë¹„ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  await fetchItems();Â 
                  socket.emit('shuffleAndPrepare');
              }
        });
        
        // ********** ìœ ì°°ì ê²½ë§¤ ì‹œì‘ ë²„íŠ¼ **********
        startRaffleButton.addEventListener('click', () => {
              if (currentBidData.isRaffleRound) {
                  // ìœ ì°°ì ê²½ë§¤ê°€ ì§„í–‰ ì¤‘ì¼ ë•Œ: ë‹¤ìŒ ìœ ì°°ì ê²½ë§¤ ì‹œì‘
                  if (confirm('ë‹¤ìŒ ìœ ì°°ì ê²½ë§¤ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                      startRaffleButton.disabled = true;
                      socket.emit('startNextAuction'); // startNextAuctionìœ¼ë¡œ í†µí•© ì²˜ë¦¬
                  }
              } else {
                  // 1ì°¨ ê²½ë§¤ ì¢…ë£Œ í›„: ìœ ì°°ì ê²½ë§¤ ë¼ìš´ë“œ ì‹œì‘
                  if (confirm('ìœ ì°°ì ê²½ë§¤ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ëœë¤ ìˆœì„œ)')) {
                      startRaffleButton.disabled = true;
                      socket.emit('startRaffleRound');
                  }
              }
        });
        
        // ********** [ê°•ì œ ë°°ì • ë²„íŠ¼ - í•­ìƒ í™œì„±í™”] **********
        assignPlayerButton.addEventListener('click', () => {
            // ê²½ë§¤ ìƒíƒœì™€ ê´€ê³„ì—†ì´ currentItemì´ ìˆì„ ë•Œë§Œ ì‘ë™
            if (!currentBidData.currentItem) {
                alert('í˜„ì¬ ê²½ë§¤ì— ì˜¬ë¼ì˜¨ ì„ ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ ê°•ì œ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê²½ë§¤ ì‹œì‘ ë˜ëŠ” ìœ ì°°ì ê²½ë§¤ ì‹œì‘ í•„ìš”)');
                return;
            }
            
            const teamNames = allTeams.map(t => t.name);
            let teamName = prompt(`${currentBidData.currentItem.nickname} ì„ ìˆ˜ë¥¼ ê°•ì œ ë°°ì •í•  íŒ€ ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”: \n(${teamNames.join(', ')})`);
            
            if (teamName) {
                teamName = teamName.trim();
                const targetTeam = allTeams.find(t => t.name === teamName);
                if (targetTeam) {
                    if (targetTeam.players.length >= 4) {
                        alert(`${teamName} íŒ€ì€ ë¡œìŠ¤í„°ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    if (confirm(`${currentBidData.currentItem.nickname} ì„ ìˆ˜ë¥¼ ${teamName}ì— 0ì›ìœ¼ë¡œ ê°•ì œ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        assignPlayerButton.disabled = true;
                        socket.emit('assignItemToTeam', { teamName: teamName });
                    }
                } else {
                    alert(`íŒ€ëª… "${teamName}"ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }
            }
        });

        // ë‹¤ìŒ ê²½ë§¤ ì‹œì‘ ë²„íŠ¼
        startNextButton.addEventListener('click', () => {
              if (currentBidData.currentItemIndex >= allItems.length) {
                  alert('ëª¨ë“  ê²½ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                  return;
              }
              if (confirm('ë‹¤ìŒ ê²½ë§¤ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  socket.emit('startNextAuction');
              }
        });

        // ê²½ë§¤ ì¢…ë£Œ ë²„íŠ¼
        endButton.addEventListener('click', () => {
            if (!currentBidData.isStarted) return;
            
            const highestBidder = currentBidData.highestBidderNickname;
            if (highestBidder === 'ì—†ìŒ' || highestBidder.includes('ì¢…ë£Œ')) {
                if (!confirm('ì…ì°°ìê°€ ì—†ìŠµë‹ˆë‹¤. ìœ ì°° ì²˜ë¦¬í•˜ê³  ë‹¤ìŒ ê²½ë§¤ë¡œ ë„˜ì–´ê°€ì‹œê² ìŠµë‹ˆê¹Œ? (íƒ€ì´ë¨¸ ê°•ì œ ì¢…ë£Œ)')) return;
            } else {
                  if (!confirm(`ìµœê³  ì…ì°°ì(${highestBidder})ì—ê²Œ ìë™ ë‚™ì°° ì²˜ë¦¬í•˜ê³  ë‹¤ìŒ ê²½ë§¤ë¡œ ë„˜ì–´ê°€ì‹œê² ìŠµë‹ˆê¹Œ? (íƒ€ì´ë¨¸ ê°•ì œ ì¢…ë£Œ)`)) return;
            }
            
            socket.emit('endAuction');
        });
        
        // *************************************************************
        // [ê²½ë§¤ ì´ˆê¸°í™” ê¸°ëŠ¥] ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        // *************************************************************
        resetAuctionButton.addEventListener('click', () => {
            if (confirm('ğŸš¨ ê²½ê³ : ê²½ë§¤ ìƒíƒœ, ì˜ˆì‚°, ë¡œìŠ¤í„°, ë‚™ì°° ì •ë³´ ë“± ëª¨ë“  ê²ƒì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                socket.emit('reset_auction'); // â¬…ï¸ server.jsì— ì¶”ê°€í•œ ì´ë²¤íŠ¸ ì „ì†¡
                alert('ê²½ë§¤ ì „ì²´ ì´ˆê¸°í™” ìš”ì²­ì„ ì„œë²„ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤. í™”ë©´ì´ ê°±ì‹ ë©ë‹ˆë‹¤.');
                // ì´ˆê¸°í™” í›„, í™”ë©´ì„ ì¦‰ì‹œ ê°±ì‹ í•˜ê¸° ìœ„í•´ ìµœì‹  ë°ì´í„°ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
                fetchItems();
            }
        });
        // *************************************************************


        // í˜„ì¬ ì…ì°° ì •ë³´ ì—…ë°ì´íŠ¸ ìˆ˜ì‹  (View íƒ­ ìš”ì†Œ ëª¨ë‘ ì—…ë°ì´íŠ¸)
        socket.on('updateBid', (data) => {
            currentBidData = data;Â 
            
            // View íƒ­ ì—…ë°ì´íŠ¸
            currentBidElementView.textContent = (data.amount || 0).toLocaleString() + 'ì›';
            highestBidderNicknameElementView.textContent = data.bidderNickname || 'ì—†ìŒ';
            statusElementView.textContent = data.isStarted ? 'ì§„í–‰ ì¤‘' : 'ëŒ€ê¸° ì¤‘';
            
            // Host ì œì–´ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const failedItemsCount = allItems.filter(item => item.winner === 'ìœ ì°°').length;
            const currentItemIndex = data.currentItemIndex;
            const processedItems = allItems.filter(item => item.isAuctioned || item.winner === 'ìœ ì°°');
            const isAllItemsProcessed = processedItems.length === allItems.length; // 1ì°¨ ê²½ë§¤ ì²˜ë¦¬ ì™„ë£Œ ì—¬ë¶€


            if (data.isStarted) {
                // ê²½ë§¤ ì§„í–‰ ì¤‘: ëª¨ë“  ì‹œì‘/ë‹¤ìŒ ë²„íŠ¼ ë¹„í™œì„±í™”
                startNextButton.disabled = true;
                endButton.disabled = false;
                startRaffleButton.disabled = true;
                
                // [ê°•ì œ ë°°ì •] ê²½ë§¤ ì§„í–‰ ì¤‘ì—ë„ í™œì„±í™”
                assignPlayerButton.disabled = false; 
            } else {
                // ê²½ë§¤ ëŒ€ê¸° ì¤‘: ì¢…ë£Œ ë¹„í™œì„±í™”
                endButton.disabled = true;

                // [ê°•ì œ ë°°ì •] í˜„ì¬ ê²½ë§¤ ëŒ€ìƒì´ ìˆì„ ë•Œë§Œ í™œì„±í™” (ë²„íŠ¼ì´ ì˜ë¯¸ìˆê²Œ ë™ì‘í•˜ë ¤ë©´)
                assignPlayerButton.disabled = (data.currentItemIndex < 0);
                
                // 1ì°¨ ê²½ë§¤ ëª¨ë“œ
                if (!data.isRaffleRound) {
                    // 1ì°¨ ê²½ë§¤ê°€ ëë‚¬ëŠ”ì§€ í™•ì¸
                    if (isAllItemsProcessed) {
                        startNextButton.disabled = true; // ë‹¤ìŒ ê²½ë§¤ ë²„íŠ¼ ë¹„í™œì„±í™”
                        
                        // ìœ ì°°ìê°€ ìˆë‹¤ë©´ ìœ ì°°ì ê²½ë§¤ ë²„íŠ¼ í™œì„±í™”
                        startRaffleButton.disabled = failedItemsCount === 0;
                        startRaffleButton.textContent = failedItemsCount > 0 ? `ìœ ì°°ì ê²½ë§¤ ì‹œì‘ (${failedItemsCount}ëª…)` : 'ìœ ì°°ì ì—†ìŒ';
                    } else {
                        // ì•„ì§ 1ì°¨ ê²½ë§¤ê°€ ë‚¨ì•„ìˆë‹¤ë©´ ë‹¤ìŒ ê²½ë§¤ ë²„íŠ¼ í™œì„±í™”
                        startNextButton.disabled = false; 
                        startRaffleButton.disabled = true;
                    }
                }Â 
                // 2ì°¨ ìœ ì°°ì ê²½ë§¤ ëª¨ë“œ
                else {
                    startNextButton.disabled = true;
                    
                    // ìœ ì°°ì ëª©ë¡ì˜ ì´ ê°œìˆ˜ì™€ í˜„ì¬ ì¸ë±ìŠ¤ë¥¼ ë¹„êµ (ì„œë²„ê°€ ê´€ë¦¬í•˜ëŠ” failedItems ë°°ì—´ ê¸°ì¤€)
                    const raffleItems = allItems.filter(item => item.winner === 'ìœ ì°°');
                    const isRaffleFinished = currentItemIndex >= raffleItems.length;

                    if (!isRaffleFinished) {
                        startRaffleButton.textContent = "ë‹¤ìŒ ìœ ì°°ì ê²½ë§¤ ì‹œì‘";
                        startRaffleButton.disabled = false;
                        
                        // [ê°•ì œ ë°°ì •] ê²½ë§¤ ëŒ€ê¸° ì¤‘ì—ë„ í™œì„±í™” ìƒíƒœ ìœ ì§€
                    } else {
                          startRaffleButton.textContent = "ëª¨ë“  ìœ ì°°ì ì²˜ë¦¬ ì™„ë£Œ";
                          startRaffleButton.disabled = true;
                    }
                }
            }


            if (data.currentItem) {
                const item = data.currentItem;
                // í˜„ì¬ ì•„ì´í…œì´ ì „ì²´ ëª©ë¡ì˜ ëª‡ ë²ˆì§¸ì¸ì§€ í™•ì¸í•˜ëŠ” ë¡œì§
                const currentList = data.isRaffleRound ? allItems.filter(i => i.winner === 'ìœ ì°°') : allItems;
                const currentIndexInCurrentList = currentList.findIndex(i => i.id === item.id) + 1;
                const totalInCurrentList = currentList.length;

                const itemInfoHTML = `
                    <h3>${item.nickname} (ìˆœì„œ ${currentIndexInCurrentList} / ${totalInCurrentList})</h3>
                    <ul>
                        <li>í‹°ì–´: <strong>${item.tier}</strong> (${item.score}ì )</li>
                        <li>ì£¼/ë¶€ í¬ì§€ì…˜: <strong>${item.mainPos}</strong> / ${item.subPos || '-'}</li>
                        <li>ì†Œê°œ: ${item.intro || 'ì—†ìŒ'}</li>
                    </ul>
                `;
                  currentItemDivView.innerHTML = itemInfoHTML;
            } else if (isAllItemsProcessed && allTeams.length > 0) {
                  currentItemDivView.innerHTML = `<h3>ëª¨ë“  ê²½ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ìœ ì°°ì ${failedItemsCount}ëª…)</h3>`;
            } else {
                  currentItemDivView.innerHTML = `<h3>ì„ ìˆ˜ë¥¼ ë“±ë¡í•˜ê³  'ë¬´ì‘ìœ„ ì„ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</h3>`;
            }
            
            if (!data.isStarted) {
                  countdownTimerView.textContent = data.currentItemIndex >= 0 ? 'ê²½ë§¤ ëŒ€ê¸°' : 'ì¤€ë¹„ í•„ìš”';
            }
        });
        
        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('updateCountdown', (countdown) => {
              if (countdown > 0) {
                  countdownTimerView.textContent = `${countdown}ì´ˆ`;
                  countdownTimerView.style.color = countdown <= 3 ? 'red' : '#dc3545';
              } else if (currentBidData.isStarted) {
                  countdownTimerView.textContent = '0ì´ˆ (ë‚™ì°° ì²˜ë¦¬ ì¤‘)';
                  countdownTimerView.style.color = 'red';
              }
        });
        
        // ê²½ë§¤ ê²°ê³¼ ìˆ˜ì‹ 
        socket.on('auctionResult', (data) => {
            resultDivView.innerHTML = `
                <p style="color: green; font-weight: bold;">âœ… ê²½ë§¤ ì¢…ë£Œ! ì„ ìˆ˜: ${data.itemNickname}, ìµœì¢… ë‚™ì°°ê°€: ${data.finalBid.toLocaleString()}ì›</p>
                <p>ë‚™ì°°ì: ${data.winnerNickname || 'ìœ ì°°'}, ë‚™ì°° íŒ€: ${data.winnerTeam || 'ì—†ìŒ'}</p>
            `;
            countdownTimerView.textContent = 'ê²½ë§¤ ì¢…ë£Œ';
        });
        
        // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('userListUpdate', (data) => {
            renderUserList(data.users, data.captainMap, allTeams);Â 
        });
        
        // ìº¡í‹´ ë§µ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('captainMapUpdate', (newCaptainMap) => {
            captainMap = newCaptainMap;
        });

        // ì„ ìˆ˜ ëª©ë¡ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('itemUpdate', (items) => {
            renderItemList(items);
        });

        // íŒ€ ëª©ë¡ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('teamUpdate', (teams) => {
            allTeams = teams;
            renderTeamStatus(teams, teamStatusContainerView); // View íƒ­ ì—…ë°ì´íŠ¸ (Grid ì ìš©)
            renderTeamStatus(teams, teamStatusContainerControl); // Control íƒ­ ì—…ë°ì´íŠ¸ (Grid ì ìš©)
            renderUserList(Object.values(socket.io.engine.clients), captainMap, allTeams); // Control íƒ­ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´
        });
        
        socket.on('connect', () => {
              socket.emit('requestUserList');
              fetchItems();
        });

        // ì´ˆê¸° íƒ­ ì„¤ì •
        tabViewBtn.click();
    </script>
</body>
</html>